sudo: required
dist: trusty
language: node_js
node_js:
- 8.7.0
branches:
  only:
  - master
  - VER3-252_buildProcess
addons:
  chrome: stable
apt:
  sources:
  - google-chrome
  packages:
  - google-chrome-stable
  - google-chrome-beta
env:
  global:
  - EC2_SSH_KEY=glimmpsev3uat.pem GIT_SSH_KEY=id_rsa EC2_URL=ec2-54-161-9-34.compute-1.amazonaws.com
    ECR_REPO=543872078551.dkr.ecr.us-east-1.amazonaws.com/glimmpse ECR_IMG=glimmpse
    GIT_MAIL=alasdair.macleod@ufl.edu GIT_USER=alasdair-macleod GIT_REPO=DemoAppFront
before_install:
- openssl aes-256-cbc -K $encrypted_ac40f3edab40_key -iv $encrypted_ac40f3edab40_iv in secret_keys.tar.enc -out secret_keys.tar -d
- ls -lrt ./scripts/*.sh
- in secrets_keys.tar.enc -out secrets_keys.tar -d
- tar xvf secrets_keys.tar
- chmod 600 glimmpsev3uat.pem
- chmod 600 id_rsa
- eval "$(ssh-agent -s)"
- sudo ssh-add ${GIT_SSH_KEY}
- git config --global user.name GIT_USER
- git config --global user.email GIT_EMAIL
- git remote set-url origin git@github.com:${GIT_USER}/${GIT_REPO}.git
- export CHROME_BIN=chromium-browser
- export DISPLAY=:99.0
- sh -e /etc/init.d/xvfb start
before_script:
- npm install -g @angular/cli
- npm install -g karma
- npm install
script:
- "./node_modules/.bin/karma start karma.conf.js --single-run --log-level=DEBUG"
after_success:
- |
  echo $TAG_ENABLE
  if [ $TAG_ENABLE == True ]; then
    # #############################################################################################################
    # increment version
    # #############################################################################################################
    echo start...
    git status
    if [ $BUILD_TYPE != patch -a $BUILD_TYPE != minor -a $BUILD_TYPE != major ]; then travis_terminate 1; fi
    npm version $BUILD_TYPE -m "updating version and deploying [skip ci]"
    # #############################################################################################################
    # build project since there is no error
    # #############################################################################################################
    ng build --prod
    # #############################################################################################################
    # install docker as the travis docker service version is too old
    # #############################################################################################################
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
    sudo apt-get update
    apt-cache policy docker-ce
    sudo apt-get install -y docker-ce
    # up data pip
    pip install -U pip
    # #############################################################################################################
    # install awscli
    # #############################################################################################################
    sudo pip install awscli --upgrade
    export PATH=~/.local/bin:$PATH
    # #############################################################################################################
    # add Aws IAM user credentials to env
    # #############################################################################################################
    mkdir -p ~/.aws
    ./scripts/ecr_user.sh
    # #############################################################################################################
    # login ECR
    # #############################################################################################################
    eval $(aws ecr get-login --no-include-email --region us-east-1)
    # #############################################################################################################
    # create docker image and push to ECR
    # #############################################################################################################
    ./scripts/docker_preserve.sh
    # #############################################################################################################
    # deploy latest docker image to EC2
    # #############################################################################################################
    ./scripts/docker_deploy.sh ;
  else echo "All tests passed.";
  fi
- echo "done"
